<!DOCTYPE html>
<html>
<head>
    <title>Athlete Activities Chart</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f4f4f4;
            margin: 0;
        }
        .chart-container {
            width: 80%;
            max-width: 900px;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .upload-btn {
            display: inline-block;
            background-color: #fc4c02;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 12px 16px;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 16px;
        }
        .upload-btn:hover {
            background-color: #e04302;
        }
        .legend-toggles {
            margin: 8px 0 0 0;
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }
        .legend-toggles label {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        .legend-swatch {
            width: 14px;
            height: 4px;
            border-radius: 2px;
            display: inline-block;
        }
        .secondary-btn {
            display: inline-block;
            background-color: #ffffff;
            color: #333;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 12px 16px;
            font-size: 16px;
            cursor: pointer;
            margin-left: 8px;
            margin-bottom: 16px;
        }
        .secondary-btn:hover {
            background-color: #f6f6f6;
        }
        .coming-soon {
            display: none;
            height: 60vh;
            min-height: 360px;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: #666;
        }
        .location-table-container {
            margin-top: 24px;
        }
        .location-table-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #333;
        }
        .location-table {
            width: 100%;
            border-collapse: collapse;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            background-color: #fff;
        }
        .location-table thead {
            background: linear-gradient(135deg, #fc4c02 0%, #e04302 100%);
            color: #fff;
        }
        .location-table th {
            padding: 14px 16px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            letter-spacing: 0.5px;
        }
        .location-table tbody tr {
            transition: background-color 0.2s ease;
        }
        .location-table tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        .location-table tbody tr:hover {
            background-color: #e8f4f8;
            cursor: pointer;
        }
        .location-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 14px;
        }
        .location-table td:first-child {
            font-weight: 500;
            color: #333;
        }
        .location-table td:last-child {
            font-weight: 600;
            color: #fc4c02;
        }
    </style>
</head>
<body>
    <div class="chart-container">
        <button id="uploadBtn" class="upload-btn">Upload JSON</button>
        <button id="callApiBtn" class="secondary-btn">Call Strava API</button>
        <input type="file" id="jsonFileInput" accept="application/json" style="display:none;">
        <div id="sportControls" class="legend-toggles"></div>
        <canvas id="activitiesChart"></canvas>
        <div id="speedPowerControls" class="legend-toggles"></div>
        <canvas id="distanceChart" style="margin-top: 24px;"></canvas>
        <div id="distanceElevationControls" class="legend-toggles"></div>
        <canvas id="heartRateChart" style="margin-top: 24px;"></canvas>
        <div id="heartRateControls" class="legend-toggles"></div>
        <div id="locationChart" style="margin-top: 24px;"></div>
        <div id="comingSoon" class="coming-soon" aria-hidden="true">
            <svg width="96" height="96" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <path d="M12 2L2 7l10 5 10-5-10-5Zm0 7L2 4v13l10 5 10-5V4l-10 5Z" fill="#e0e0e0"/>
            </svg>
            <div style="margin-top:12px; font-size:18px; color:#444;">Coming soon</div>
        </div>
    </div>

    <script>
        function renderChart(activitiesData) {
            // Filter to Ride and VirtualRide only, then sort ascending by date
            const allowedSports = new Set(['Ride', 'VirtualRide']);
            const filtered = activitiesData.filter(a => allowedSports.has(a.sport_type));
            const sortedActivities = [...filtered].sort((a, b) => {
                return new Date(a.start_date_local) - new Date(b.start_date_local);
            });

            if (!sortedActivities.length) {
                const container = document.querySelector('.chart-container');
                const infoEl = document.createElement('div');
                infoEl.textContent = 'No Ride or VirtualRide activities to display.';
                infoEl.style.marginTop = '12px';
                container.appendChild(infoEl);
                return;
            }

            const labels = sortedActivities.map(activity => {
            const date = new Date(activity.start_date_local);
                return date.toLocaleDateString();
            });

            const data = sortedActivities.map(activity => {
                return Number((activity.average_speed * 3.6).toFixed(2));
            });

            const avgWatts = sortedActivities.map(activity => {
                return (typeof activity.average_watts === 'number') ? Math.round(activity.average_watts) : null;
            });

            // Build sport filter toggles
            buildSportToggles();

            function buildSportToggles() {
                const container = document.getElementById('sportControls');
                container.innerHTML = '';
                const config = [
                    { key: 'Ride', color: '#2e7d32', label: 'Ride' },
                    { key: 'VirtualRide', color: '#1e88e5', label: 'VirtualRide' }
                ];
                const state = { Ride: true, VirtualRide: true };
                const counts = {
                    Ride: activitiesData.filter(a => a.sport_type === 'Ride').length,
                    VirtualRide: activitiesData.filter(a => a.sport_type === 'VirtualRide').length
                };

                config.forEach(({ key, color, label }) => {
                    const el = document.createElement('label');
                    const cb = document.createElement('input');
                    cb.type = 'checkbox';
                    cb.checked = true;
                    cb.addEventListener('change', () => {
                        state[key] = cb.checked;
                        // Recompute visible set and re-render all charts
                        const visible = activitiesData.filter(a => (a.sport_type in state ? state[a.sport_type] : false));
                        // Prevent empty allowedSports filtering; default both off -> empty
                        rerenderAll(visible);
                    });
                    const sw = document.createElement('span');
                    sw.className = 'legend-swatch';
                    sw.style.backgroundColor = color;
                    const txt = document.createElement('span');
                    txt.textContent = `${label} (${counts[key]})`;
                    el.appendChild(cb);
                    el.appendChild(sw);
                    el.appendChild(txt);
                    container.appendChild(el);
                });

                // Initial render with both on
                rerenderAll(activitiesData);
            }

            function rerenderAll(currentData) {
                // Filter and sort current set
                const allowed = new Set(['Ride', 'VirtualRide']);
                const filteredNow = currentData.filter(a => allowed.has(a.sport_type));
                const sortedNow = [...filteredNow].sort((a, b) => new Date(a.start_date_local) - new Date(b.start_date_local));

                drawCharts(sortedNow);
            }

            // Keep references to charts so we can destroy them before re-creating
            window.speedPowerChart = window.speedPowerChart || null;
            window.distanceElevationChart = window.distanceElevationChart || null;
            window.heartRateChart = window.heartRateChart || null;

            // Helper to format dates like: Wed 1 Jun
            function formatDateLabel(dateObj) {
                const parts = new Intl.DateTimeFormat('en-GB', {
                    weekday: 'short',
                    day: 'numeric',
                    month: 'short'
                }).formatToParts(dateObj);
                const map = Object.fromEntries(parts.map(p => [p.type, p.value]));
                return `${map.weekday} ${map.day} ${map.month}`;
            }

            // Helper to format moving_time seconds to "xhrs ymins"
            function formatMovingTime(totalSeconds) {
                if (typeof totalSeconds !== 'number' || !isFinite(totalSeconds)) return '';
                const totalMinutes = Math.round(totalSeconds / 60);
                const hours = Math.floor(totalMinutes / 60);
                const mins = totalMinutes % 60;
                if (hours > 0 && mins > 0) return `${hours}hrs ${mins}mins`;
                if (hours > 0) return `${hours}hrs`;
                return `${mins}mins`;
            }

            // Helper to format timezone to simplified location
            function formatTimezone(tz) {
                if (!tz || typeof tz !== 'string') return 'Unknown';
                // Extract the location part after GMT offset
                const match = tz.match(/\(.*?\)\s*(.+)/);
                if (!match) return tz;
                const location = match[1];
                // Split by '/' and format as "City, Country"
                // Note: timezone format is "Country/City" so we need to swap
                const parts = location.split('/');
                if (parts.length === 2) {
                    const country = parts[0].replace(/_/g, ' ');
                    const city = parts[1].replace(/_/g, ' ');
                    return `${city}, ${country}`;
                }
                return location;
            }

            function drawCharts(sortedActivities) {
                if (!sortedActivities.length) {
                    const container = document.querySelector('.chart-container');
                    const infoEl = document.createElement('div');
                    infoEl.textContent = 'No activities to display with current filters.';
                    infoEl.style.marginTop = '12px';
                    container.appendChild(infoEl);
                    return;
                }
                const chartContainer = document.querySelector('.chart-container');
                // Remove previous info messages if any
                const infos = chartContainer.querySelectorAll('.info-msg');
                infos.forEach(n => n.remove());

                // Compute new series
                const labels = sortedActivities.map(activity => formatDateLabel(new Date(activity.start_date_local)));
                const data = sortedActivities.map(activity => Number((activity.average_speed * 3.6).toFixed(2)));
                const distanceKm = sortedActivities.map(activity => Number((activity.distance / 1000).toFixed(2)));
                const elevationM = sortedActivities.map(activity => Number((activity.total_elevation_gain).toFixed(0)));
                const avgWatts = sortedActivities.map(activity => (typeof activity.average_watts === 'number') ? Math.round(activity.average_watts) : null);
                const pointColors = sortedActivities.map(a => a.sport_type === 'VirtualRide' ? '#1e88e5' : '#2e7d32');

                // Destroy previous charts if they exist
                try { window.speedPowerChart && window.speedPowerChart.destroy && window.speedPowerChart.destroy(); } catch (e) {}
                try { window.distanceElevationChart && window.distanceElevationChart.destroy && window.distanceElevationChart.destroy(); } catch (e) {}
                try { window.heartRateChart && window.heartRateChart.destroy && window.heartRateChart.destroy(); } catch (e) {}

        const ctx = document.getElementById('activitiesChart').getContext('2d');
            // eslint-disable-next-line no-unused-vars
        const activitiesChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                    datasets: [
                        {
                    label: 'Average Speed (km/h)',
                    data: data,
                    borderColor: 'rgb(75, 192, 192)',
                            pointBackgroundColor: pointColors,
                            pointBorderColor: pointColors,
                            tension: 0.1,
                            fill: false,
                            yAxisID: 'ySpeed'
                        },
                        {
                            label: 'Average Power (W)',
                            data: avgWatts,
                            borderColor: 'rgb(255, 159, 64)',
                            pointBackgroundColor: pointColors,
                            pointBorderColor: pointColors,
                    tension: 0.1,
                            fill: false,
                            yAxisID: 'yWatts'
                        }
                    ]
            },
            options: {
                responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                title: (items) => {
                                    if (!items || !items.length) return '';
                                    const index = items[0].dataIndex;
                                    const act = sortedActivities[index];
                                    if (!act) return '';
                                    const name = act.name || '';
                                    const timeStr = formatMovingTime(act.moving_time);
                                    return timeStr ? `${name} | ${timeStr}` : name;
                                },
                                label: (item) => {
                                    if (item.dataset && item.dataset.label && item.dataset.label.includes('Power')) {
                                        return `Average Power: ${item.formattedValue} W`;
                                    }
                                    return `Average Speed: ${item.formattedValue} km/h`;
                                }
                            }
                        }
                    },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Start Date Local'
                        }
                    },
                        ySpeed: {
                            type: 'linear',
                            position: 'left',
                        title: {
                            display: true,
                            text: 'Average Speed (km/h)'
                        },
                        beginAtZero: true
                        },
                        yWatts: {
                            type: 'linear',
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Average Power (W)'
                            },
                            grid: {
                                drawOnChartArea: false
                            },
                            beginAtZero: true
                        }
                    }
                }
            });

        // Click-to-open activity on speed/power chart
        activitiesChart.options.onClick = (evt) => {
            const points = activitiesChart.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, true);
            if (!points || !points.length) return;
            const index = points[0].index;
            const activity = sortedActivities[index];
            if (activity && activity.id) {
                window.open(`https://www.strava.com/activities/${activity.id}/analysis`, '_blank');
            }
        };
        activitiesChart.update();

            // Build toggles for activitiesChart datasets
            buildLegendToggles('speedPowerControls', activitiesChart);
            window.speedPowerChart = activitiesChart;

                const distanceCtx = document.getElementById('distanceChart').getContext('2d');
            // eslint-disable-next-line no-unused-vars
                const distanceChart = new Chart(distanceCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Distance (km)',
                            data: distanceKm,
                            borderColor: 'rgb(54, 162, 235)',
                            pointBackgroundColor: pointColors,
                            pointBorderColor: pointColors,
                            tension: 0.1,
                            fill: false,
                            yAxisID: 'yDistance'
                        },
                        {
                            label: 'Elevation Gain (m)',
                            data: elevationM,
                            borderColor: 'rgb(255, 99, 132)',
                            pointBackgroundColor: pointColors,
                            pointBorderColor: pointColors,
                            tension: 0.1,
                            fill: false,
                            yAxisID: 'yElevation'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                title: (items) => {
                                    if (!items || !items.length) return '';
                                    const index = items[0].dataIndex;
                                    const act = sortedActivities[index];
                                    if (!act) return '';
                                    const name = act.name || '';
                                    const timeStr = formatMovingTime(act.moving_time);
                                    return timeStr ? `${name} | ${timeStr}` : name;
                                },
                                label: (item) => {
                                    if (item.dataset && item.dataset.label && item.dataset.label.includes('Elevation')) {
                                        return `Elevation Gain: ${item.formattedValue} m`;
                                    }
                                    return `Distance: ${item.formattedValue} km`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Start Date Local'
                            }
                        },
                        yDistance: {
                            type: 'linear',
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Distance (km)'
                            },
                            beginAtZero: true
                        },
                        yElevation: {
                            type: 'linear',
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Elevation Gain (m)'
                            },
                            grid: {
                                drawOnChartArea: false
                            },
                            beginAtZero: true
                        }
                    }
                }
            });

        // Click-to-open activity on distance/elevation chart
        distanceChart.options.onClick = (evt) => {
            const points = distanceChart.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, true);
            if (!points || !points.length) return;
            const index = points[0].index;
            const activity = sortedActivities[index];
            if (activity && activity.id) {
                window.open(`https://www.strava.com/activities/${activity.id}/analysis`, '_blank');
            }
        };
        distanceChart.update();

                // Rebuild dataset toggles after rendering
                buildLegendToggles('speedPowerControls', activitiesChart);
                buildLegendToggles('distanceElevationControls', distanceChart);
                window.distanceElevationChart = distanceChart;

                // Heart rate chart (average and max)
                const avgHr = sortedActivities.map(a => (typeof a.average_heartrate === 'number') ? Math.round(a.average_heartrate) : null);
                const maxHr = sortedActivities.map(a => (typeof a.max_heartrate === 'number') ? Math.round(a.max_heartrate) : null);
                const sufferScore = sortedActivities.map(a => (typeof a.suffer_score === 'number') ? Math.round(a.suffer_score) : null);
                const hrCtx = document.getElementById('heartRateChart').getContext('2d');
                const heartRateChart = new Chart(hrCtx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Average HR (bpm)',
                                data: avgHr,
                                borderColor: '#8e24aa',
                                pointBackgroundColor: pointColors,
                                pointBorderColor: pointColors,
                                tension: 0.1,
                                fill: false
                            },
                            {
                                label: 'Max HR (bpm)',
                                data: maxHr,
                                borderColor: '#d81b60',
                                pointBackgroundColor: pointColors,
                                pointBorderColor: pointColors,
                                tension: 0.1,
                                fill: false
                            },
                            {
                                label: 'Suffer Score',
                                data: sufferScore,
                                borderColor: '#ff9800',
                                pointBackgroundColor: pointColors,
                                pointBorderColor: pointColors,
                                tension: 0.1,
                                fill: false,
                                yAxisID: 'ySuffer'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    title: (items) => {
                                        if (!items || !items.length) return '';
                                        const index = items[0].dataIndex;
                                        const act = sortedActivities[index];
                                        if (!act) return '';
                                        const name = act.name || '';
                                        const timeStr = formatMovingTime(act.moving_time);
                                        return timeStr ? `${name} | ${timeStr}` : name;
                                    },
                                    label: (item) => {
                                        if (item.dataset && item.dataset.label && item.dataset.label.includes('Suffer')) {
                                            return `Suffer Score: ${item.formattedValue}`;
                                        }
                                        return `${item.dataset.label}: ${item.formattedValue} bpm`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: { display: true, text: 'Start Date Local' }
                            },
                            y: {
                                title: { display: true, text: 'Heart Rate (bpm)' },
                                beginAtZero: false
                            },
                            ySuffer: {
                                type: 'linear',
                                position: 'right',
                                title: { display: true, text: 'Suffer Score' },
                                grid: { drawOnChartArea: false },
                                beginAtZero: true
                            }
                        }
                    }
                });

                // Click-to-open for heart rate chart
                heartRateChart.options.onClick = (evt) => {
                    const points = heartRateChart.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, true);
                    if (!points || !points.length) return;
                    const index = points[0].index;
                    const activity = sortedActivities[index];
                    if (activity && activity.id) {
                        window.open(`https://www.strava.com/activities/${activity.id}/analysis`, '_blank');
                    }
                };
                heartRateChart.update();
                window.heartRateChart = heartRateChart;
                buildLegendToggles('heartRateControls', heartRateChart);

                // Location table - count activities by timezone
                const locationCounts = {};
                sortedActivities.forEach(a => {
                    const formattedLocation = formatTimezone(a.timezone);
                    locationCounts[formattedLocation] = (locationCounts[formattedLocation] || 0) + 1;
                });
                
                // Sort by count (descending)
                const sortedLocations = Object.entries(locationCounts)
                    .sort((a, b) => b[1] - a[1]);
                
                // Generate table HTML
                const locationContainer = document.getElementById('locationChart');
                let tableHTML = '<div class="location-table-title">Ride locations</div>';
                tableHTML += '<table class="location-table">';
                tableHTML += '<thead><tr><th>Location</th><th>Activities</th></tr></thead>';
                tableHTML += '<tbody>';
                sortedLocations.forEach(([location, count]) => {
                    tableHTML += `<tr><td>${location}</td><td>${count}</td></tr>`;
                });
                tableHTML += '</tbody></table>';
                locationContainer.innerHTML = tableHTML;
            }

            // Helper to render checkbox toggles that control dataset visibility
            function buildLegendToggles(containerId, chartInstance) {
                const container = document.getElementById(containerId);
                container.innerHTML = '';
                if (!chartInstance || !chartInstance.data || !Array.isArray(chartInstance.data.datasets)) {
                    return;
                }
                chartInstance.data.datasets.forEach((ds, idx) => {
                    const label = document.createElement('label');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.checked = chartInstance.isDatasetVisible(idx);
                    checkbox.addEventListener('change', () => {
                        chartInstance.setDatasetVisibility(idx, checkbox.checked);
                        chartInstance.update();
                    });
                    const swatch = document.createElement('span');
                    swatch.className = 'legend-swatch';
                    swatch.style.backgroundColor = ds.borderColor || '#666';
                    const text = document.createElement('span');
                    text.textContent = ds.label || `Series ${idx + 1}`;
                    label.appendChild(checkbox);
                    label.appendChild(swatch);
                    label.appendChild(text);
                    container.appendChild(label);
                });
            }
        }

        const fileInputEl = document.getElementById('jsonFileInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const callApiBtn = document.getElementById('callApiBtn');
        const comingSoonEl = document.getElementById('comingSoon');

        uploadBtn.addEventListener('click', () => {
            // Reset value so selecting the same file again still triggers change
            fileInputEl.value = '';
            fileInputEl.click();
        });
        fileInputEl.addEventListener('change', (e) => {
            const file = e.target.files && e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = () => {
                let activities;
                try {
                    activities = parseActivities(reader.result);
                } catch (err) {
                    console.error(err);
                    alert(`Failed to parse JSON file: ${err.message}`);
                    return;
                }
                try {
                    // Ensure charts UI is visible if previously hidden by "Call Strava API"
                    showChartsUI();
                    renderChart(activities);
                } catch (err) {
                    console.error(err);
                    alert(`Failed to load data into charts: ${err.message}`);
                }
                // Reset the input so the same file can be selected again later
                fileInputEl.value = '';
            };
            reader.readAsText(file);
        });

        // Placeholder navigation for Call Strava API
        callApiBtn.addEventListener('click', () => {
            const sections = [
                'sportControls', 'activitiesChart', 'speedPowerControls',
                'distanceChart', 'distanceElevationControls',
                'heartRateChart', 'heartRateControls', 'locationChart'
            ];
            sections.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });
            comingSoonEl.style.display = 'flex';
            comingSoonEl.setAttribute('aria-hidden', 'false');
        });

        function showChartsUI() {
            const sections = [
                'sportControls', 'activitiesChart', 'speedPowerControls',
                'distanceChart', 'distanceElevationControls',
                'heartRateChart', 'heartRateControls', 'locationChart'
            ];
            sections.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = '';
            });
            comingSoonEl.style.display = 'none';
            comingSoonEl.setAttribute('aria-hidden', 'true');
        }

        function parseActivities(rawText) {
            // Strip BOM and trim
            let text = rawText.replace(/^\uFEFF/, '').trim();
            // Try plain JSON array
            try {
                const parsed = JSON.parse(text);
                if (Array.isArray(parsed)) return parsed;
                if (parsed && Array.isArray(parsed.activities)) return parsed.activities;
                if (parsed && Array.isArray(parsed.data)) return parsed.data;
                throw new Error('Top-level JSON is not an array of activities.');
            } catch (_) {
                // Fallback: NDJSON (one JSON object per line)
                const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
                if (lines.length > 1) {
                    const items = [];
                    for (const line of lines) {
                        try {
                            const obj = JSON.parse(line);
                            items.push(obj);
                        } catch (e) {
                            // If any line fails, abort NDJSON path
                            throw new Error('Invalid JSON format (not array or NDJSON).');
                        }
                    }
                    return items;
                }
                // If single-line and failed, rethrow generic error
                throw new Error('Invalid JSON format. Expected array of activities.');
            }
        }
    </script>
</body>
</html>
